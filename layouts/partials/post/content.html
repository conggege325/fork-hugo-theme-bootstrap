{{ $passwd := .Params.passwd | default "" }}

<div class="post-content mb-3" data-bs-spy="scroll" data-bs-target="#TableOfContents" tabindex="0">
    {{- if and .Summary (default false $.Site.Params.post.readMoreFromContent) (hasPrefix .Content .Summary) }}
    <div id="post-summary">{{ .Summary }}</div>
    <div id="post-content-body">
        {{- if ne $passwd "" -}}
        <div class="secret_content">
            <div class="alert alert-warning" role="alert">
                <h4 class="alert-heading">友情提示</h4>
                <p>该文章属于私密文章；请联系作者获取密码。</p>
            </div>
            <form id="validationForm" class="row g-3 needs-validation" novalidate>
                <div class="col-12">
                    <input type="password" class="form-control" id="validationPassword" required placeholder="请输入密码">
                    <div class="invalid-feedback">密码不能为空</div>
                </div>
                <div class="col-12" style="text-align: right;">
                    <button class="btn btn-primary" type="submit">确定</button>
                </div>
            </form>
        </div>
        <script>
            {{- $safeContent := strings.TrimPrefix .Summary .Content | safeHTML | string -}}
            const ciphertext = '{{- aes_enc $safeContent .Params.passwd $.Site.Params.secretIv -}}'
            document.addEventListener('show_content', function(e) {
                const originalText = decrypt(ciphertext, e.detail)
                if (originalText == null) {
                    layer.open({
                        type: 1,
                        offset: ['16px', 'calc(50% - 100px)'],
                        id: 'layer-password-error', // 防止重复弹出
                        title: false,
                        content: `<div class="alert alert-danger alert-dismissible" role="alert" style=" border-radius: 0; margin: 0; padding-top: 5px; padding-bottom: 5px; padding-left: 10px;">
                        <div class="alert-heading" style="font-weight: bolder;">密码错误!</div>
                        <div>您无权查看该文章。</div>
                        <button type="button" class="btn-close" style="padding: 5px;" onclick="layer.closeAll()"></button>
                      </div>`,
                        closeBtn: 0,
                        shade: 0, // 不显示遮罩
                        time: 3000,
                    });
                } else {
                    $('#post-content-body').append(originalText)
                    $('.secret_content').hide()
                }
            });
            $(function() {
                $("#validationForm").submit(function(e) {
                    const form = e.target
                    if (form.checkValidity()) {
                        let secretKey = $('#validationPassword')[0].value;
                        if (secretKey.length > 32) {
                            secretKey = secretKey.substring(0, 32)
                        } else if(secretKey.length < 32) {
                            secretKey = secretKey.padEnd(32, '0')
                        }
                        const event = new CustomEvent('show_content', { detail: secretKey });
                        document.dispatchEvent(event);
                    }
                    e.preventDefault()
                    e.stopPropagation()
                });
            });
        </script>
        {{- else -}}
        {{- strings.TrimPrefix .Summary .Content | safeHTML -}}
        {{- end -}}
    </div>
    {{- else }}
    <div id="post-content-body">
        {{- if ne $passwd "" -}}
        <div class="secret_content">
            <div class="alert alert-warning" role="alert">
                <h4 class="alert-heading">友情提示</h4>
                <p>该文章属于私密文章；请联系作者获取密码。</p>
            </div>
            <form id="validationForm" class="row g-3 needs-validation" novalidate>
                <div class="col-12">
                    <input type="password" class="form-control" id="validationPassword" required placeholder="请输入密码">
                    <div class="invalid-feedback">密码不能为空</div>
                </div>
                <div class="col-12" style="text-align: right;">
                    <button class="btn btn-primary" type="submit">确定</button>
                </div>
            </form>
        </div>
        <script>
            {{- $unsafeContent := .Content | string -}}
            const ciphertext = '{{- aes_enc $unsafeContent .Params.passwd $.Site.Params.secretIv -}}'
            document.addEventListener('show_content', function(e) {
                const originalText = decrypt(ciphertext, e.detail)
                if (originalText == null) {
                    layer.open({
                        type: 1,
                        offset: ['16px', 'calc(50% - 100px)'],
                        id: 'layer-password-error', // 防止重复弹出
                        title: false,
                        content: `<div class="alert alert-danger alert-dismissible" role="alert" style=" border-radius: 0; margin: 0; padding-top: 5px; padding-bottom: 5px; padding-left: 10px;">
                        <div class="alert-heading" style="font-weight: bolder;">密码错误!</div>
                        <div>您无权查看该文章。</div>
                        <button type="button" class="btn-close" style="padding: 5px;" onclick="layer.closeAll()"></button>
                      </div>`,
                        closeBtn: 0,
                        shade: 0, // 不显示遮罩
                        time: 3000,
                    });
                } else {
                    $('#post-content-body').append(originalText)
                    $('.secret_content').hide()
                }
            });
            $(function() {
                $("#validationForm").submit(function(e) {
                    const form = e.target
                    if (form.checkValidity()) {
                        let secretKey = $('#validationPassword')[0].value;
                        if (secretKey.length > 32) {
                            secretKey = secretKey.substring(0, 32)
                        } else if(secretKey.length < 32) {
                            secretKey = secretKey.padEnd(32, '0')
                        }
                        const event = new CustomEvent('show_content', { detail: secretKey });
                        document.dispatchEvent(event);
                    }
                    e.preventDefault()
                    e.stopPropagation()
                });
            });
        </script>
        {{- else -}}
        {{ .Content }}
        {{- end -}}
    </div>
    {{- end }}
</div>
